name: Check Version Update

on:
  push:
    branches:
      - main

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Push tag for each updated package
        run: |
          git config --global user.name "SDK Releaser Bot"
          git config --global user.email "noreply@stackit.de"

          for file in $(git diff --name-only HEAD~1..HEAD | grep pyproject.toml); do    
              if git diff HEAD~1..HEAD $file | grep "version ="; then
                  version_changes=$(git diff HEAD~1..HEAD $file | grep "version =")
                  splitted_version_changes=($(echo "$version_changes" | grep -oP '(?<=version = )[^ ]*'))
                  # Check if all versions are equal
                  if [ $(echo "${splitted_version_changes[@]}" | tr ' ' '\n' | sort -u | wc -l) -ne 1 ]; then        
                      dirpath=$(dirname $file)        
                      current_version=$(grep -o "version = .*" ${file} | cut -d '=' -f 2-)
                      dirpath=$(dirname $file)
                      relpath=${file#*/core|stackit/*}
                      cleaned_version=$(echo "$current_version" | tr -d '" ')
                      tag=$(echo "${dirpath}/${cleaned_version}")                
                      git tag -a $tag -m "Release $cleaned_version"        
                      git push origin tag $tag          
                  fi            
              fi            
          done